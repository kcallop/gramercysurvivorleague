<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survivor 50 Fantasy League</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@400;600&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --fire: #ff6b1a;
    --ember: #ff3d00;
    --gold: #e8c44a;
    --deep: #1a0a00;
    --dark: #0f1a0a;
    --torch: #ff8c42;
    --ash: #c2b89a;
    --leaf: #2d5a1b;
    --sky: #1b3a5a;
    --cream: #f5ead8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--deep);
    color: var(--cream);
    font-family: 'Lato', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
    background-image: 
      radial-gradient(ellipse at 20% 0%, rgba(255,107,26,0.18) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 100%, rgba(27,58,90,0.3) 0%, transparent 50%),
      repeating-linear-gradient(
        45deg,
        transparent,
        transparent 60px,
        rgba(255,140,66,0.02) 60px,
        rgba(255,140,66,0.02) 61px
      );
  }

  header {
    text-align: center;
    padding: 2.5rem 1rem 1.5rem;
    position: relative;
    border-bottom: 1px solid rgba(232,196,74,0.25);
    background: linear-gradient(180deg, rgba(255,61,0,0.12) 0%, transparent 100%);
  }

  .flame-row {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .flame {
    font-size: 1.6rem;
    animation: flicker 1.5s ease-in-out infinite alternate;
  }
  .flame:nth-child(2) { animation-delay: 0.3s; }
  .flame:nth-child(3) { animation-delay: 0.6s; }
  .flame:nth-child(4) { animation-delay: 0.2s; }
  .flame:nth-child(5) { animation-delay: 0.5s; }

  @keyframes flicker {
    0% { transform: scaleY(1) rotate(-2deg); filter: brightness(1); }
    100% { transform: scaleY(1.15) rotate(2deg); filter: brightness(1.3); }
  }

  h1 {
    font-family: 'Cinzel Decorative', cursive;
    font-size: clamp(1.4rem, 4vw, 2.4rem);
    color: var(--gold);
    text-shadow: 0 0 30px rgba(232,196,74,0.5), 0 2px 4px rgba(0,0,0,0.8);
    letter-spacing: 0.05em;
  }

  .subtitle {
    font-family: 'Cinzel', serif;
    font-size: 0.85rem;
    color: var(--ash);
    letter-spacing: 0.3em;
    margin-top: 0.3rem;
    text-transform: uppercase;
  }

  nav {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    flex-wrap: wrap;
  }

  .tab-btn {
    background: transparent;
    border: 1px solid rgba(232,196,74,0.3);
    color: var(--ash);
    font-family: 'Cinzel', serif;
    font-size: 0.78rem;
    letter-spacing: 0.15em;
    padding: 0.5rem 1.2rem;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .tab-btn.active, .tab-btn:hover {
    background: var(--gold);
    color: var(--deep);
    border-color: var(--gold);
  }

  .view { display: none; padding: 1.5rem 1rem 3rem; max-width: 1100px; margin: 0 auto; }
  .view.active { display: block; }

  /* STANDINGS */
  .standings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
    gap: 1.2rem;
    margin-bottom: 2rem;
  }

  .team-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
    border: 1px solid rgba(232,196,74,0.2);
    border-top: 3px solid var(--gold);
    padding: 1.2rem;
    position: relative;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .team-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(255,107,26,0.2);
  }

  .team-card.rank-1 { border-top-color: var(--gold); }
  .team-card.rank-2 { border-top-color: #aaa; }
  .team-card.rank-3 { border-top-color: #cd7f32; }

  .team-rank {
    font-family: 'Cinzel Decorative', cursive;
    font-size: 2rem;
    color: rgba(232,196,74,0.2);
    position: absolute;
    top: 0.5rem;
    right: 0.8rem;
  }

  .team-name {
    font-family: 'Cinzel', serif;
    font-size: 0.9rem;
    color: var(--gold);
    font-weight: 600;
    margin-bottom: 0.3rem;
  }

  .team-total {
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--cream);
    line-height: 1;
  }

  .team-total span {
    font-size: 0.8rem;
    color: var(--ash);
    font-weight: 300;
  }

  .team-castaways-mini {
    margin-top: 0.8rem;
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  .castaway-mini-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--ash);
    padding: 0.15rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .castaway-mini-row.eliminated { opacity: 0.4; text-decoration: line-through; }
  .castaway-mini-row .pts { color: var(--cream); font-weight: 700; }
  .castaway-mini-row .pts.negative { color: #ff6b6b; }

  /* DRAFT */
  .draft-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.2rem;
    margin-bottom: 2rem;
  }

  .draft-team {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(232,196,74,0.2);
    padding: 1rem;
  }

  .draft-team-header {
    font-family: 'Cinzel', serif;
    color: var(--gold);
    font-size: 0.85rem;
    font-weight: 600;
    padding-bottom: 0.6rem;
    border-bottom: 1px solid rgba(232,196,74,0.2);
    margin-bottom: 0.8rem;
    letter-spacing: 0.05em;
  }

  .draft-slot {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.35rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 0.8rem;
    min-height: 32px;
  }

  .draft-slot .slot-name { color: var(--cream); }
  .draft-slot .slot-empty { color: rgba(255,255,255,0.25); font-style: italic; }

  .remove-btn {
    background: none;
    border: none;
    color: #ff6b6b;
    cursor: pointer;
    font-size: 1rem;
    padding: 0 0.2rem;
    opacity: 0.6;
    transition: opacity 0.2s;
  }
  .remove-btn:hover { opacity: 1; }

  .castaway-pool {
    margin-top: 1rem;
  }

  .pool-label {
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    color: var(--ash);
    letter-spacing: 0.2em;
    text-transform: uppercase;
    margin-bottom: 0.8rem;
  }

  .pool-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .pool-chip {
    background: rgba(232,196,74,0.1);
    border: 1px solid rgba(232,196,74,0.3);
    color: var(--cream);
    font-size: 0.75rem;
    padding: 0.3rem 0.7rem;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    gap: 0.4rem;
    align-items: center;
  }

  .pool-chip:hover { background: rgba(232,196,74,0.25); }
  .pool-chip.drafted { opacity: 0.3; cursor: not-allowed; pointer-events: none; }

  .team-select {
    background: var(--deep);
    border: 1px solid rgba(232,196,74,0.3);
    color: var(--gold);
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    padding: 0.25rem 0.4rem;
    cursor: pointer;
    outline: none;
    max-width: 130px;
  }

  /* SCORING */
  .week-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .week-label {
    font-family: 'Cinzel Decorative', cursive;
    font-size: 1.1rem;
    color: var(--gold);
  }

  .week-nav {
    display: flex;
    gap: 0.4rem;
  }

  .week-nav button {
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(232,196,74,0.25);
    color: var(--cream);
    padding: 0.3rem 0.8rem;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.15s;
  }

  .week-nav button:hover { background: rgba(232,196,74,0.2); }

  .scoring-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
  }

  .scoring-table thead tr {
    background: rgba(232,196,74,0.1);
    border-bottom: 2px solid rgba(232,196,74,0.3);
  }

  .scoring-table th {
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    color: var(--gold);
    padding: 0.6rem 0.5rem;
    text-align: center;
    white-space: nowrap;
  }

  .scoring-table th.left { text-align: left; }

  .scoring-table tbody tr {
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: background 0.15s;
  }

  .scoring-table tbody tr:hover { background: rgba(255,255,255,0.03); }
  .scoring-table tbody tr.eliminated-row { opacity: 0.4; }

  .scoring-table td {
    padding: 0.5rem 0.5rem;
    text-align: center;
    color: var(--ash);
  }

  .scoring-table td.left { text-align: left; color: var(--cream); font-weight: 600; }

  .score-toggle {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.2);
    background: transparent;
    cursor: pointer;
    font-size: 0.7rem;
    color: var(--ash);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    font-family: 'Lato', sans-serif;
  }

  .score-toggle.active {
    background: var(--fire);
    border-color: var(--fire);
    color: white;
    box-shadow: 0 0 8px rgba(255,107,26,0.5);
  }

  .score-toggle.negative.active {
    background: #c0392b;
    border-color: #c0392b;
    box-shadow: 0 0 8px rgba(192,57,43,0.5);
  }

  .row-score {
    font-weight: 700;
    color: var(--cream);
    font-size: 0.95rem;
    min-width: 36px;
    display: inline-block;
  }

  .row-score.negative { color: #ff6b6b; }

  .team-badge {
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    border-radius: 2px;
    white-space: nowrap;
    font-family: 'Cinzel', serif;
    letter-spacing: 0.05em;
  }

  .eliminated-badge {
    background: rgba(192,57,43,0.3);
    border: 1px solid rgba(192,57,43,0.5);
    color: #ff6b6b;
    font-size: 0.6rem;
    padding: 0.1rem 0.4rem;
    margin-left: 0.4rem;
  }

  /* RULES panel */
  .rules-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(232,196,74,0.2);
    border-left: 4px solid var(--gold);
    padding: 1.5rem;
    margin-bottom: 1.2rem;
  }

  .rules-card h3 {
    font-family: 'Cinzel', serif;
    color: var(--gold);
    font-size: 0.9rem;
    letter-spacing: 0.15em;
    margin-bottom: 1rem;
    text-transform: uppercase;
  }

  .rule-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.4rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    font-size: 0.85rem;
    color: var(--ash);
  }

  .rule-pts {
    font-weight: 700;
    font-family: 'Cinzel', serif;
    font-size: 0.9rem;
  }

  .rule-pts.pos { color: var(--gold); }
  .rule-pts.neg { color: #ff6b6b; }

  .section-title {
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    color: var(--fire);
    text-transform: uppercase;
    margin: 2rem 0 1rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }

  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(255,107,26,0.3);
  }

  .action-btn {
    background: var(--fire);
    border: none;
    color: white;
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    padding: 0.6rem 1.4rem;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .action-btn:hover {
    background: var(--ember);
    box-shadow: 0 4px 15px rgba(255,61,0,0.4);
  }

  .action-btn.secondary {
    background: transparent;
    border: 1px solid rgba(232,196,74,0.4);
    color: var(--gold);
  }

  .action-btn.secondary:hover {
    background: rgba(232,196,74,0.1);
  }

  .flex-row { display: flex; gap: 0.8rem; align-items: center; flex-wrap: wrap; }

  .snuff-row {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.8rem;
    background: rgba(192,57,43,0.1);
    border: 1px solid rgba(192,57,43,0.3);
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .snuff-row label {
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    color: #ff6b6b;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .snuff-select {
    background: var(--deep);
    border: 1px solid rgba(192,57,43,0.5);
    color: var(--cream);
    font-size: 0.8rem;
    padding: 0.3rem 0.6rem;
    outline: none;
    flex: 1;
    min-width: 150px;
    max-width: 250px;
  }

  .sync-status {
    display: inline-block;
    font-family: 'Lato', sans-serif;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    padding: 0.2rem 0.7rem;
    border-radius: 2px;
    margin-top: 0.5rem;
    transition: all 0.3s;
  }
  .sync-status.saved { background: rgba(67,232,160,0.12); color: #43e8a0; border: 1px solid rgba(67,232,160,0.3); }
  .sync-status.saving { background: rgba(232,196,74,0.12); color: var(--gold); border: 1px solid rgba(232,196,74,0.3); }
  .sync-status.error { background: rgba(192,57,43,0.2); color: #ff6b6b; border: 1px solid rgba(192,57,43,0.4); }

  .fire-icon { color: var(--fire); }
</style>
</head>
<body>

<header>
  <div class="flame-row">
    <span class="flame">üî•</span>
    <span class="flame">üî•</span>
    <span class="flame">üî•</span>
    <span class="flame">üî•</span>
    <span class="flame">üî•</span>
  </div>
  <h1>SURVIVOR 50</h1>
  <div class="subtitle">Fantasy League &bull; In The Hands of Sophie Lewis</div>
  <div><span id="sync-status" class="sync-status saving">‚ü≥ Loading‚Ä¶</span></div>
</header>

<nav>
  <button class="tab-btn active" onclick="showView('standings')">Standings</button>
  <button class="tab-btn" onclick="showView('draft')">Draft / Roster</button>
  <button class="tab-btn" onclick="showView('scoring')">Score Week</button>
  <button class="tab-btn" onclick="showView('rules')">Rules</button>
</nav>

<div id="standings" class="view active">
  <div class="section-title">Leaderboard</div>
  <div id="standings-grid" class="standings-grid"></div>
</div>

<div id="draft" class="view">
  <div class="section-title">Team Rosters</div>
  <div id="draft-grid" class="draft-grid"></div>
  <div class="castaway-pool">
    <div class="pool-label">Available Castaways ‚Äî click to assign</div>
    <div id="pool-grid" class="pool-grid"></div>
  </div>
</div>

<div id="scoring" class="view">
  <div class="week-header">
    <span class="week-label" id="week-label">Week 1</span>
    <div class="week-nav">
      <button onclick="changeWeek(-1)">‚óÄ Prev</button>
      <button onclick="changeWeek(1)">Next ‚ñ∂</button>
    </div>
  </div>

  <div class="snuff-row" style="flex-direction:column; align-items:flex-start; gap:0.6rem;">
    <div style="display:flex; align-items:center; gap:0.8rem; flex-wrap:wrap; width:100%;">
      <label>üïØ Torches Snuffed This Week:</label>
      <small style="color:var(--ash); font-size:0.7rem;">(supports multiple eliminations ‚Äî double tribal, etc.)</small>
    </div>
    <div style="display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap;">
      <select class="snuff-select" id="elim-select">
        <option value="">‚Äî Select castaway ‚Äî</option>
      </select>
      <button class="action-btn" style="padding:0.35rem 0.9rem; font-size:0.75rem;" onclick="addElimination()">+ Snuff Torch</button>
    </div>
    <div id="snuffed-list" style="display:flex; flex-wrap:wrap; gap:0.4rem;"></div>
  </div>

  <table class="scoring-table">
    <thead>
      <tr>
        <th class="left">Castaway</th>
        <th>Team</th>
        <th title="Survived the week">üëü<br>Survive<br>+1</th>
        <th title="Won individual immunity">üèÜ<br>Ind. Imm<br>+3</th>
        <th title="Won tribal immunity challenge">üõ°<br>Tribe Imm<br>+2</th>
        <th title="Found or played idol/advantage">ü™¨<br>Idol/Adv<br>+3</th>
        <th title="Lost their vote">üö´<br>Lost Vote<br>‚àí1</th>
        <th title="Voted out this week">‚ò†<br>Voted Out<br>‚àí5</th>
        <th title="Made final tribal council">‚≠ê<br>Final TC<br>+5</th>
        <th title="Won Survivor">üëë<br>Winner<br>+10</th>
        <th>Pts</th>
      </tr>
    </thead>
    <tbody id="scoring-tbody"></tbody>
  </table>
  <div style="margin-top:1rem; display:flex; gap:0.8rem; flex-wrap:wrap;">
    <button class="action-btn" onclick="lockWeek()">üîí Lock Week & Save</button>
    <button class="action-btn secondary" onclick="clearWeek()">Clear Week</button>
  </div>
</div>

<div id="rules" class="view">
  <div class="rules-card">
    <h3>Scoring Rules</h3>
    <div class="rule-row"><span>Survive the week (not voted out)</span><span class="rule-pts pos">+1 pt</span></div>
    <div class="rule-row"><span>Win individual immunity challenge</span><span class="rule-pts pos">+3 pts</span></div>
    <div class="rule-row"><span>Win tribal immunity challenge</span><span class="rule-pts pos">+2 pts</span></div>
    <div class="rule-row"><span>Find or play an idol / advantage</span><span class="rule-pts pos">+3 pts</span></div>
    <div class="rule-row"><span>Lose their vote</span><span class="rule-pts neg">‚àí1 pt</span></div>
    <div class="rule-row"><span>Voted out (including on their boot week)</span><span class="rule-pts neg">‚àí5 pts</span></div>
    <div class="rule-row"><span>Appear at Final Tribal Council</span><span class="rule-pts pos">+5 pts</span></div>
    <div class="rule-row"><span>Win Survivor</span><span class="rule-pts pos">+10 pts</span></div>
  </div>
  <div class="rules-card">
    <h3>League Format</h3>
    <div class="rule-row"><span>Teams</span><span style="color:var(--cream)">4 teams, 6 castaways each</span></div>
    <div class="rule-row"><span>Season</span><span style="color:var(--cream)">Survivor Season 50</span></div>
    <div class="rule-row"><span>Scoring</span><span style="color:var(--cream)">Cumulative across all episodes</span></div>
  </div>
</div>

<script type="module">
const TEAMS = [
  "Cruise Lesbians",
  "Marbles",
  "The Jewish Center of NorthWest Jersey",
  "Miscellaneous Boyfriends"
];

const CASTAWAYS = [
  "Angelina Keeley","Aubry Bracco","Coach","Charlie Davis",
  "Chrissy Hofbeck","Christian Hubicki","Cirie Fields","Colby Donaldson",
  "Dee","Emily Flippen","Genevieve Mushaluk",
  "Jenna Lewis-Dougherty","Joe Hunter","Jonathan Young","Kamilla Karthigesu",
  "Kyle Fraser","Mike White","Ozzy","Q",
  "Rick Devens","Rizo Velovic","Savannah Louie","Stephenie LaGrossa Kendrick",
  "Tiffany Ervin"
];

const SCORING = {
  survive: 1, ind_imm: 3, tribe_imm: 2, idol: 3, lost_vote: -1, voted_out: -5, final_tc: 5, winner: 10
};

// ============================================================
//  FIREBASE CONFIG ‚Äî paste your values here after setup
// ============================================================
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyAl4w_9Re0kyCBb1hDdAGkRLmY93j1Svg0",
  authDomain:        "gramercy-survivor-league.firebaseapp.com",
  databaseURL:       "https://gramercy-survivor-league-default-rtdb.firebaseio.com",
  projectId:         "gramercy-survivor-league",
};
// ============================================================

// State
let state = {
  assignments: {},
  eliminated: {},
  weekScores: {},
  currentWeek: 1
};

let db = null;
let dbRef = null;
let saveTimeout = null;

function setSyncStatus(status, msg) {
  const el = document.getElementById('sync-status');
  if (!el) return;
  el.className = 'sync-status ' + status;
  el.textContent = msg;
}

function isConfigured() {
  return !FIREBASE_CONFIG.apiKey.includes('PASTE_YOUR');
}

async function initFirebase() {
  if (!isConfigured()) {
    setSyncStatus('error', '‚ö† Firebase not configured ‚Äî data saves locally only');
    // Fall back to localStorage so the app still works untouched
    const saved = localStorage.getItem('s50fantasy');
    if (saved) { try { state = JSON.parse(saved); } catch(e) {} }
    return false;
  }

  try {
    // Load Firebase SDKs dynamically
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
    const { getDatabase, ref, set, onValue } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js');

    const app = initializeApp(FIREBASE_CONFIG);
    db = getDatabase(app);
    dbRef = ref(db, 'league');

    // Listen for real-time updates from any device
    onValue(dbRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        state = data;
        setSyncStatus('saved', '‚úì Synced');
        // Re-render active view
        const active = document.querySelector('.view.active');
        if (active) {
          if (active.id === 'standings') renderStandings();
          if (active.id === 'draft') renderDraft();
          if (active.id === 'scoring') renderScoring();
        }
      }
    });

    return true;
  } catch(e) {
    console.error('Firebase init failed:', e);
    setSyncStatus('error', '‚úó Firebase error ‚Äî check console');
    return false;
  }
}

async function save() {
  // Always keep a local backup
  localStorage.setItem('s50fantasy', JSON.stringify(state));

  if (!isConfigured() || !db) return;

  setSyncStatus('saving', '‚ü≥ Saving‚Ä¶');
  // Debounce rapid saves (e.g. quick toggle clicks) by 400ms
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(async () => {
    try {
      const { ref, set } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js');
      await set(ref(db, 'league'), state);
      setSyncStatus('saved', '‚úì Synced');
    } catch(e) {
      console.error('Save failed:', e);
      setSyncStatus('error', '‚úó Save failed ‚Äî check connection');
    }
  }, 400);
}

async function init() {
  setSyncStatus('saving', '‚ü≥ Connecting‚Ä¶');
  const ok = await initFirebase();
  if (!ok) {
    // Not configured yet ‚Äî just render with local/empty state
    renderStandings();
  }
  // If Firebase is configured, onValue will fire immediately and trigger renderStandings
}

function castawayTeam(c) { return state.assignments[c] || null; }
function isEliminated(c) { return state.eliminated[c] !== undefined; }
function eliminatedWeek(c) { return state.eliminated[c]; }

function castawayTotalPoints(c) {
  let pts = 0;
  for (const [wk, scores] of Object.entries(state.weekScores)) {
    const s = scores[c];
    if (!s) continue;
    if (s.survive) pts += SCORING.survive;
    if (s.ind_imm) pts += SCORING.ind_imm;
    if (s.tribe_imm) pts += SCORING.tribe_imm;
    if (s.idol) pts += SCORING.idol;
    if (s.lost_vote) pts += SCORING.lost_vote;
    if (s.voted_out) pts += SCORING.voted_out;
    if (s.final_tc) pts += SCORING.final_tc;
    if (s.winner) pts += SCORING.winner;
  }
  return pts;
}

function teamTotalPoints(team) {
  return CASTAWAYS.filter(c => castawayTeam(c) === team)
    .reduce((sum, c) => sum + castawayTotalPoints(c), 0);
}

function getWeekScore(castaway, field) {
  return !!(state.weekScores[state.currentWeek]?.[castaway]?.[field]);
}

function setWeekScore(castaway, field, val) {
  if (!state.weekScores[state.currentWeek]) state.weekScores[state.currentWeek] = {};
  if (!state.weekScores[state.currentWeek][castaway]) state.weekScores[state.currentWeek][castaway] = {};
  state.weekScores[state.currentWeek][castaway][field] = val;
}

function castawayWeekPoints(c, wk) {
  const s = state.weekScores[wk]?.[c];
  if (!s) return 0;
  let pts = 0;
  if (s.survive) pts += 1;
  if (s.ind_imm) pts += 3;
  if (s.tribe_imm) pts += 2;
  if (s.idol) pts += 3;
  if (s.lost_vote) pts -= 1;
  if (s.voted_out) pts -= 5;
  if (s.final_tc) pts += 5;
  if (s.winner) pts += 10;
  return pts;
}

// TEAM COLORS for badges
const TEAM_COLORS = {
  "Cruise Lesbians": "#e84393",
  "Marbles": "#43b0e8",
  "The Jewish Center of NorthWest Jersey": "#43e8a0",
  "Miscellaneous Boyfriends": "#e8a043"
};

function teamBadge(team) {
  if (!team) return '';
  const short = team.length > 14 ? team.substring(0, 13) + '‚Ä¶' : team;
  const col = TEAM_COLORS[team] || '#aaa';
  return `<span class="team-badge" style="background:${col}22;border:1px solid ${col}66;color:${col};">${short}</span>`;
}

// Views
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.target.classList.add('active');
  if (id === 'standings') renderStandings();
  if (id === 'draft') renderDraft();
  if (id === 'scoring') renderScoring();
}

// STANDINGS
function renderStandings() {
  const grid = document.getElementById('standings-grid');
  const sorted = [...TEAMS].sort((a, b) => teamTotalPoints(b) - teamTotalPoints(a));
  grid.innerHTML = sorted.map((team, i) => {
    const pts = teamTotalPoints(team);
    const members = CASTAWAYS.filter(c => castawayTeam(c) === team);
    const unassigned = members.length === 0;
    const color = TEAM_COLORS[team] || '#aaa';
    const rows = members.length > 0
      ? members.sort((a,b) => castawayTotalPoints(b)-castawayTotalPoints(a)).map(c => {
          const p = castawayTotalPoints(c);
          return `<div class="castaway-mini-row${isEliminated(c) ? ' eliminated' : ''}">
            <span>${c.split(' ').slice(0,2).join(' ')}</span>
            <span class="pts${p < 0 ? ' negative' : ''}">${p > 0 ? '+' : ''}${p}</span>
          </div>`;
        }).join('')
      : '<div style="color:rgba(255,255,255,0.25);font-size:0.75rem;font-style:italic;">No castaways drafted yet</div>';
    return `<div class="team-card rank-${i+1}" style="border-top-color:${color};">
      <div class="team-rank">${i+1}</div>
      <div class="team-name" style="color:${color};">${team}</div>
      <div class="team-total">${pts} <span>pts</span></div>
      <div class="team-castaways-mini">${rows}</div>
    </div>`;
  }).join('');
}

// DRAFT
function renderDraft() {
  const grid = document.getElementById('draft-grid');
  grid.innerHTML = TEAMS.map(team => {
    const members = CASTAWAYS.filter(c => castawayTeam(c) === team);
    const color = TEAM_COLORS[team] || '#aaa';
    const slots = Array.from({length:6}, (_, i) => {
      const c = members[i];
      if (c) return `<div class="draft-slot">
        <span class="slot-name">${c}</span>
        <button class="remove-btn" onclick="unassign('${c.replace(/'/g,"\\'")}')">‚úï</button>
      </div>`;
      return `<div class="draft-slot"><span class="slot-empty">‚Äî open slot ‚Äî</span></div>`;
    }).join('');
    return `<div class="draft-team" style="border-top:3px solid ${color};">
      <div class="draft-team-header" style="color:${color};">${team} (${members.length}/6)</div>
      ${slots}
    </div>`;
  }).join('');

  // Pool
  const pool = document.getElementById('pool-grid');
  pool.innerHTML = CASTAWAYS.map(c => {
    const assigned = castawayTeam(c);
    const elim = isEliminated(c);
    return `<div class="pool-chip${assigned ? ' drafted' : ''}" onclick="openAssign('${c.replace(/'/g,"\\'")}')">
      ${elim ? '‚ò† ' : ''}${c}
      ${assigned ? ` <span style="font-size:0.6rem;opacity:0.6;">(${castawayTeam(c).split(' ')[0]})</span>` : ''}
    </div>`;
  }).join('');
}

async function openAssign(castaway) {
  if (castawayTeam(castaway)) return;
  const team = prompt(`Assign "${castaway}" to which team?\n\n${TEAMS.map((t,i)=>`${i+1}. ${t}`).join('\n')}\n\nEnter number (1-4):`);
  if (!team) return;
  const idx = parseInt(team) - 1;
  if (idx < 0 || idx >= TEAMS.length) return;
  const chosen = TEAMS[idx];
  const currentCount = CASTAWAYS.filter(c => castawayTeam(c) === chosen).length;
  if (currentCount >= 6) { alert(`${chosen} already has 6 castaways!`); return; }
  state.assignments[castaway] = chosen;
  await save();
  renderDraft();
}

async function unassign(castaway) {
  if (!confirm(`Remove ${castaway} from their team?`)) return;
  delete state.assignments[castaway];
  await save();
  renderDraft();
}

// SCORING
function thisWeekEliminated() {
  return Object.entries(state.eliminated).filter(([c,w]) => w === state.currentWeek).map(([c]) => c);
}

function renderSnuffedList() {
  const snuffed = thisWeekEliminated();
  const el = document.getElementById('snuffed-list');
  if (snuffed.length === 0) {
    el.innerHTML = '<span style="color:rgba(255,255,255,0.25);font-size:0.75rem;font-style:italic;">No eliminations yet this week</span>';
  } else {
    el.innerHTML = snuffed.map(c =>
      `<span style="display:inline-flex;align-items:center;gap:0.4rem;background:rgba(192,57,43,0.25);border:1px solid rgba(192,57,43,0.5);color:#ff9080;font-size:0.78rem;padding:0.2rem 0.5rem;">
        ‚ò† ${c}
        <button onclick="removeElimination('${c.replace(/'/g,"\\'")}')}" style="background:none;border:none;color:#ff6b6b;cursor:pointer;font-size:0.9rem;padding:0 0.1rem;" title="Undo">‚úï</button>
      </span>`
    ).join('');
  }
}

async function addElimination() {
  const sel = document.getElementById('elim-select');
  const c = sel.value;
  if (!c) return;
  state.eliminated[c] = state.currentWeek;
  setWeekScore(c, 'voted_out', true);
  setWeekScore(c, 'survive', false);
  sel.value = '';
  await save();
  renderScoring();
}

async function removeElimination(c) {
  delete state.eliminated[c];
  setWeekScore(c, 'voted_out', false);
  await save();
  renderScoring();
}

function renderScoring() {
  document.getElementById('week-label').textContent = `Week ${state.currentWeek}`;

  // Populate elim select ‚Äî only show currently active castaways not yet snuffed this week
  const alreadyOut = thisWeekEliminated();
  const sel = document.getElementById('elim-select');
  const available = CASTAWAYS.filter(c => !isEliminated(c) || alreadyOut.includes(c));
  const eligible = available.filter(c => !alreadyOut.includes(c));
  sel.innerHTML = '<option value="">‚Äî Select castaway ‚Äî</option>' +
    eligible.map(c => `<option value="${c}">${c}</option>`).join('');

  renderSnuffedList();

  const tbody = document.getElementById('scoring-tbody');
  const fields = ['survive','ind_imm','tribe_imm','idol','lost_vote','voted_out','final_tc','winner'];
  const negFields = ['lost_vote','voted_out'];

  tbody.innerHTML = CASTAWAYS.map(c => {
    const eliminated = isEliminated(c);
    const thisWeekElim = eliminatedWeek(c) === state.currentWeek;
    // Skip eliminated from previous weeks (show but greyed)
    const prevElim = eliminated && !thisWeekElim;

    let pts = 0;
    fields.forEach(f => { if (getWeekScore(c,f)) pts += SCORING[f]; });

    const team = castawayTeam(c);
    const color = team ? (TEAM_COLORS[team] || '#aaa') : '';

    const toggles = fields.map(f => {
      const active = getWeekScore(c, f);
      const neg = negFields.includes(f);
      const disabled = prevElim ? 'disabled style="opacity:0.2;cursor:not-allowed;"' : '';
      return `<td><button class="score-toggle${active?' active':''}${neg?' negative':''}" 
        ${disabled}
        onclick="toggle('${c.replace(/'/g,"\\'")}','${f}')">${active ? '‚úì' : ''}</button></td>`;
    }).join('');

    return `<tr class="${prevElim ? 'eliminated-row' : ''}">
      <td class="left">
        ${c}
        ${prevElim ? '<span class="eliminated-badge">OUT</span>' : ''}
        ${thisWeekElim ? '<span class="eliminated-badge">VOTED OUT</span>' : ''}
      </td>
      <td>${team ? `<span class="team-badge" style="background:${color}22;border:1px solid ${color}66;color:${color};">${team.split(' ')[0]}</span>` : '<span style="color:rgba(255,255,255,0.2);font-size:0.7rem;">‚Äî</span>'}</td>
      ${toggles}
      <td><span class="row-score${pts < 0 ? ' negative' : ''}">${pts >= 0 ? '+' : ''}${pts}</span></td>
    </tr>`;
  }).join('');
}

async function toggle(castaway, field) {
  const cur = getWeekScore(castaway, field);
  setWeekScore(castaway, field, !cur);
  await save();
  renderScoring();
}


async function changeWeek(delta) {
  const next = state.currentWeek + delta;
  if (next < 1) return;
  state.currentWeek = next;
  await save();
  renderScoring();
}

async function lockWeek() {
  const thisWeekOut = thisWeekEliminated();
  CASTAWAYS.forEach(c => {
    const prevElim = isEliminated(c) && eliminatedWeek(c) < state.currentWeek;
    if (!prevElim && !thisWeekOut.includes(c)) {
      if (!getWeekScore(c, 'survive')) setWeekScore(c, 'survive', true);
    }
  });
  const elimMsg = thisWeekOut.length > 0
    ? ` ${thisWeekOut.length} castaway${thisWeekOut.length > 1 ? 's' : ''} eliminated.`
    : ' No eliminations recorded.';
  state.currentWeek++;
  await save();
  alert(`‚úÖ Week ${state.currentWeek - 1} locked!${elimMsg} Survival points auto-applied. Moving to Week ${state.currentWeek}.`);
  renderScoring();
}

async function clearWeek() {
  if (!confirm('Clear all scores for this week?')) return;
  delete state.weekScores[state.currentWeek];
  for (const [c, wk] of Object.entries(state.eliminated)) {
    if (wk === state.currentWeek) delete state.eliminated[c];
  }
  await save();
  renderScoring();
}

// Expose to window for inline onclick handlers
window.showView = showView;
window.openAssign = openAssign;
window.unassign = unassign;
window.addElimination = addElimination;
window.removeElimination = removeElimination;
window.toggle = toggle;
window.changeWeek = changeWeek;
window.lockWeek = lockWeek;
window.clearWeek = clearWeek;

// Boot
init();
</script>
</body>
</html>
